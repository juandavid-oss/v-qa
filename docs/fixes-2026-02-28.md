# Fixes 2026-02-28

Este documento resume los arreglos aplicados para la integracion Frame.io -> analisis en Cloud Function y los cambios de UI del reproductor.

## 1) Descarga de video desde Frame.io

### Problema observado
- `ffmpeg` fallaba con `moov atom not found`.
- En logs se veia `Content-Type: text/html` y `Downloaded 0.0 MB`.
- Se estaba intentando descargar `view_url` (`https://next.frame.io/.../view/...`), que es pagina web, no archivo de video.

### Causas raiz
- Fallback incorrecto a `view_url` cuando no habia media link directo.
- `include=media_links` en V4 no devolvia media links firmados para este asset.
- El parametro correcto en V4 debe pedir media links explicitos:
  - `media_links.original`
  - `media_links.high_quality`
  - `media_links.efficient`
  - etc.

### Arreglos aplicados
- Se elimino el uso de `view_url` como URL descargable.
- Se detectan y rechazan URLs de vista de Frame.io.
- Se fuerza re-resolucion de metadata si `project.video_url` guardado es URL de vista.
- Se amplio el parser de links (`download_url`, `secure_download_url`, `source_url`, `src`, etc).
- Se agrego heuristica recursiva para detectar links validos de video en payloads complejos.
- Se corrigio `include` en V4 para pedir media links explicitos.

### Archivos clave
- `src/lib/frame-io.ts`
- `src/app/api/analyze/route.ts`
- `cloud-functions/analyze-video/main.py`

## 2) Robustez de descarga en Cloud Function

### Arreglos aplicados
- Validacion temprana de descarga:
  - si llega `text/html` o archivo demasiado pequeno, falla con error claro.
- Logging adicional para diagnosticar URL, content-type y tamano.
- Se mantuvo setup de ffmpeg estatico en runtime.

## 3) Modelo Gemini para transcripcion

### Problema observado
- `404 This model models/gemini-2.0-flash is no longer available to new users`.

### Arreglo aplicado
- Se dejo de depender de un solo modelo fijo.
- Nuevo flujo con fallback:
  1. `GEMINI_MODEL` (si existe en env)
  2. `gemini-2.5-flash`
  3. `gemini-1.5-flash`
- Si un modelo falla por no disponibilidad, prueba el siguiente.
- Si falla por otra razon, propaga el error real.

### Archivo clave
- `cloud-functions/analyze-video/main.py`

## 4) UI del reproductor

### Objetivo
- Evitar que el tamano del reproductor cambie segun el video cargado.
- Hacer el viewport visualmente mas pequeno.

### Arreglo aplicado
- Viewport fijo por breakpoint (`h-[220/280/360/405]`).
- Ancho maximo fijo (`max-w-[760px]`) centrado.
- `object-contain` sobre un canvas negro estable.

### Archivo clave
- `src/components/dashboard/VideoPreview.tsx`

## Commits relacionados
- `113335b` Add static ffmpeg download and error logging to Cloud Function
- `d84be9f` fix: use Python tarfile module for ffmpeg extraction
- `5f18335` debug: add download logging to diagnose moov atom not found error
- `975d6b3` fix: reject frame.io view URLs and re-resolve direct video links
- `0d1fa0b` fix: support additional Frame.io media link URL keys
- `4d2f900` fix: add heuristic fallback to extract Frame.io direct video URLs
- `b3ffd3d` fix: request explicit Frame.io media_links include fields

## Pendiente recomendado
- Migrar de `google.generativeai` (deprecated) a `google.genai`.
- Rotar todas las credenciales expuestas durante debugging y actualizar secrets en infraestructura.
